<!DOCTYPE html>
	<head>
        <% include ../shared/_header %>
        <link rel="stylesheet" href="/stylesheets/typeahead.css"/>
        <link rel="stylesheet" href="/stylesheets/select2.css"/>
        <link rel="stylesheet" href="/stylesheets/index.css"/>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.min.js"></script>
        <script type="text/javascript" src="/javascripts/typeahead.bundle.js"></script>
		<script type="text/javascript" src="/javascripts/Chart.js"></script>
		<script>
			function getQuerystringNameValue(name){
				var winURL = window.location.href;
				var queryStringArray = winURL.split("?");
				var queryStringParamArray = queryStringArray[1].split("&");
				var nameValue = null;
			
				for ( var i=0; i<queryStringParamArray.length; i++ )
				{           
					queryStringNameValueArray = queryStringParamArray[i].split("=");
			
					if ( name == queryStringNameValueArray[0] )
					{
						nameValue = queryStringNameValueArray[1];
					}                       
				}
			
				return nameValue;
			}	
			function getObjects(obj, key, val) {
				var objects = [];
				for (var i in obj) {
					if (!obj.hasOwnProperty(i)) continue;
					if (typeof obj[i] == 'object') {
						objects = objects.concat(getObjects(obj[i], key, val));
					} else if (i == key && obj[key] == val) {
						objects.push(obj);
					}
				}
				return objects;
			}
			
     //       var courseID = getQuerystringNameValue("course");
     //       var course = getObjects(obj.courses, "course_id", courseID);
    //        var reviews = getObjects(obj.users, "course_id", courseID);
            //Calculate average rating
    /*        var ratingSum = 0;
            for(var i = 0; i < reviews.length; i++){
                ratingSum += reviews[i].rating;
            }
            if(reviews.length > 0){
                var ratingAvg = (ratingSum / reviews.length).toFixed(2);
            }
            else{
                var ratingAvg = "NA";
            }
            //Calculate average difficulty
            var difficultySum = 0;
            for(var i = 0; i < reviews.length; i++){
                difficultySum += reviews[i].difficulty;
            }
            if(reviews.length > 0){
                var difficultyAvg = (difficultySum / reviews.length).toFixed(2);
            }
            else{
                var difficultyAvg = "NA";
            }
            //Calculate average grade
            gradeArray = {"A":4.0, "A-":3.7, "B+":3.3, "B":3.0, "B-":2.7, "C+":2.3, "C":2.0, "C-":1.7, "D+":1.3, "D":1.0, "D-":0.7, "F+":0.3, "F":0.0};
            var pointArray = [4.0, 3.7, 3.3, 3.0, 2.7, 2.3, 2.0, 1.7, 1.3, 1.0, 0.7, 0.3, 0.0];
            var letterArray = ["A", "A-", "B+", "B", "B-", "C+", "C", "C-", "D+", "D", "D-", "F+", "F"];
            var gradeSum = 0;
            for(var i = 0; i < reviews.length; i++){
                gradeSum += gradeArray[reviews[i].grade];
            }
            if(reviews.length > 0){
                var gradeAvg = (gradeSum / reviews.length).toFixed(2);
                var diffArray = pointArray;
                for(var i = 0; i < pointArray.length; i++){
                    diffArray[i] = Math.abs(pointArray[i] - gradeAvg);
                }
                leastDiff = Math.min.apply(Math, diffArray);
                var avgLetterGrade = letterArray[diffArray.indexOf(leastDiff)];
            }
            else{
                var avgLetterGrade = "NA";
            }
            */
            //AJAX post request to database, returns course object
            function getCourse(){
                var id = getQuerystringNameValue('course');
                $.ajax( {
                    url: '/course',
                    type: 'POST',
                    data: {"query": "courses", "id" : id},
                    success: function(course) {
                        getReviews(course);
                    }
                });
            }
            
            //AJAX post request to database, returns course object
            function getReviews(course){
                var id = getQuerystringNameValue('course');
                var course_id = course[0].course_id;
                $.ajax( {
                    url: '/course',
                    type: 'POST',
                    data: {"query": "reviews", "id" : id, "course_id": course_id},
                    success: function(reviews) {
                        //render comments from array of reviews
                        renderReviews(reviews);
                    }
                });
            }
            
            //AJAX post request to database, returns list of all courses
            function addCourse(){
                var course_id = getQuerystringNameValue('course');
                $.ajax( {
                    url: '/course',
                    type: 'POST',
                    data: {"query": "add", "course_id" : course_id},
                    success: function(response) {
                        if(response == 'success'){
                            //On success of adding class to db, change class button
                            console.log('POST success');
                            document.getElementById("addButton").disabled = true;
                            document.getElementById('addButton').classList.remove('btn-danger');
                            document.getElementById('addButton').classList.add('btn-success');
                            document.getElementById("addButton").innerHTML = "Added"
                        }
                    }
                });
            }
            
		</script>
	</head>
	<body>



        <% include ../shared/_navbar %>
        <div class="container" style="padding-top: 150px">
            <div class="row">
                <div class="col-md-2"></div>
                <div class="col-md-8">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <%= courseObj.title %>
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <!--Basic Course Information-->
                                <div class="col-md-4">
                                    <label><font size="3">Instructor: &nbsp</font></label><a href="#"><%= courseObj.instructor.name %></a><br>
                                    <label><font size="3">Term: &nbsp</label><%= courseObj.term %><br>
                                    <% if(courseObj.start_time != null){ %>
                                    <label><font size="3">Class Times: &nbsp</label><%= courseObj.meeting_days %> <%= courseObj.start_time %> to <%= courseObj.end_time %><br>
                                    <% }else{%>
                                    <label><font size="3">Class Times: &nbsp</label>TBA<br>
                                    <% } %>
                                    <% if(courseObj.room != null){ %>
                                    <label><font size="3">Room: &nbsp</label><%= courseObj.room.name%> <%=courseObj.room.building_name %><br>
                                    <% }else{%>
                                    <label><font size="3">Room: &nbsp</label>NA<br>
                                    <% } %>
                                    <label><font size="3">Seats: &nbsp</label><%= courseObj.seats %><br>
                                    <% if(courseObj.rating == ""){ %>
                                    <label><font size="3">Rating: &nbsp</label>Not enough data<br>
                                    <% }else{ %>
                                    <label><font size="3">Rating: &nbsp</label><%= courseObj.rating %>/5.0<br>    
                                    <% } %>
                                    
                                    <div style="width: 100%; text-align: center;padding-top: 30px; margin-bottom: 40px">
                                        <% if(enrolled == true){ %>
                                            <button id="addButton" class="btn btn-success btn-md">Added</button>
                                        <% }else{%>
                                            <button id="addButton" class="btn btn-danger btn-md" onclick="addCourse()">Add Class</button>
                                        <% } %>
                                    </div>
                                </div>
                                <!--Ratings Graphs-->
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="panel panel-default">
                                                <div class="panel-heading">
                                                    <% if(courseObj.grade == 0){ %>
                                                    Grade: Not Enough Data
                                                    <% }else{ %>
                                                    Grade: <%= courseObj.grade %>    
                                                    <% } %>  
                                                </div>
                                                <div class="panel-body">
                                                    <div>
                                                        <canvas id="canvas" height="250" width="auto"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="panel panel-default">
                                                <div class="panel-heading">
                                                    <% if(courseObj.difficulty == ""){ %>
                                                    Difficulty: Not Enough Data
                                                    <% }else{ %>
                                                    Difficulty: <%= courseObj.difficulty %>    
                                                    <% } %>
                                                </div>
                                                <div class="panel-body">
                                                    <div>
                                                        <canvas id="canvas2" height="250" width="auto"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>  
                                    </div>  
                                </div>
                            </div>
                            <!--Reviews Section-->
                            <div class="row">
                                <div class="col-md-1"></div>
                                <div class="panel panel-default col-md-10">
                                    <div class="panel-heading">
                                        Comments
                                    </div>
                                    <div class="panel-body" id="comments">
                                        <script>
                                            function renderReviews(reviews){
                                                var html = "";
                                                for(var i = 0; i < reviews.length; i++){
                                                    if(reviews[i].comments.length > 0){
                                                        html += '<div class="row"> \
                                                                        <div class="col-md-1"></div> \
                                                                        <div class="panel panel-default col-md-10"> \
                                                                            <div class="panel-body"> \
                                                                                <span id="rating-' + reviews[i]._id + '"></span> <span style="color:#aaa;font-family:verdana;font-size:11px">' + reviews[i].timestamp + '</span> <br> \
                                                                                <i>"' + reviews[i].comments + '"</i> \
                                                                            </div> \
                                                                        </div> \
                                                                        <div class="col-md-1"></div> \
                                                                    </div>'; 
                                                    }                                                    
                                                }
                                                if(reviews.length == 0)
                                                {
                                                    html += '<p>There is no review of this class yet.</p>';                                                                                                                             
                                                }
                                                document.getElementById('comments').innerHTML = html;
                                                for(var i = 0; i < reviews.length; i++){
                                                    if(reviews[i].comments.length > 0){
                                                        for(var j = 0; j < Math.round(reviews[i].rating); j++){
                                                            document.getElementById("rating-"+reviews[i]._id).innerHTML = document.getElementById("rating-"+reviews[i]._id).innerHTML + "☆";
                                                        }
                                                    }
                                                }
                                                
                                            }
                                        </script>
                                    </div>
                                </div>
                                <div class="col-md-1"></div>
                            </div>
                        </div>
                    </div>			
                </div>	
            </div>
            <div class="col-md-2"></div>	
        </div>
			
		
        <script>
            $(document).ready(function() {  
                getCourse(); 
            });
            
            var randomScalingFactor = function(){ return Math.round(Math.random()*100)};
            var lineChartData = {
                labels : ["January","February","March","April","May","June","July"],
                datasets : [
                    {
                        label: "My First dataset",
                        fillColor : "rgba(220,220,220,0.2)",
                        strokeColor : "rgba(220,220,220,1)",
                        pointColor : "rgba(220,220,220,1)",
                        pointStrokeColor : "#fff",
                        pointHighlightFill : "#fff",
                        pointHighlightStroke : "rgba(220,220,220,1)",
                        data : [randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor()]
                    },
                    {
                        label: "My Second dataset",
                        fillColor : "rgba(151,187,205,0.2)",
                        strokeColor : "rgba(151,187,205,1)",
                        pointColor : "rgba(151,187,205,1)",
                        pointStrokeColor : "#fff",
                        pointHighlightFill : "#fff",
                        pointHighlightStroke : "rgba(151,187,205,1)",
                        data : [randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor()]
                    }
                ]
    
            }
    
            window.onload = function(){
                var ctx = document.getElementById("canvas").getContext("2d");
                window.myLine = new Chart(ctx).Line(lineChartData, {
                    responsive: true
                });
                var ctx2 = document.getElementById("canvas2").getContext("2d");
                window.myLine = new Chart(ctx2).Line(lineChartData, {
                    responsive: true
                });
            }
        </script>
	</body>
</html>
